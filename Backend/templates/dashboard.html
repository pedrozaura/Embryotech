{% extends "base.html" %} {% block title %}Embryotech - Dashboard{% endblock %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<header>
  <div class="header-content">
    <img
      src="{{ url_for('static', filename='images/logo-icon.png') }}"
      alt="Logo Embryotech"
      class="header-logo"
    />
    <h1>Dashboard Embryotech</h1>
  </div>
  <button id="logoutBtn">Sair</button>
</header>

<main>
  <section class="last-reading">
    <h2>Última Leitura</h2>
    <div id="lastReadingContainer" class="reading-card">
      <p>Carregando última leitura...</p>
    </div>
  </section>

  <!-- Botões: Histórico e Parâmetros -->
  <div class="button-group">
    <button id="showHistoryBtn">Histórico</button>
    {% if current_user and current_user.is_admin %}
    <button id="btnParametros">Gerenciar Parâmetros</button>
    {% endif %}
  </div>

  <section class="charts-section">
    <h2>Análise Gráfica</h2>
    <div class="chart-container">
      <div class="lote-selector">
        <label for="loteFilter">Selecione o Lote:</label>
        <select id="loteFilter" class="form-control">
          <option value="">Todos os Lotes</option>
          <!-- Opções serão preenchidas via JavaScript -->
        </select>
      </div>
      <h3 id="loteLabel">Lote: Carregando...</h3>
      <div class="chart-row">
        <div class="chart-wrapper">
          <h4>Temperatura (°C)</h4>
          <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h4>Umidade (%)</h4>
          <canvas id="umidChart"></canvas>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-wrapper">
          <h4>Pressão (hPa)</h4>
          <canvas id="pressChart"></canvas>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal de Histórico -->
<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Histórico de Leituras</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body" id="readingsListContainer">
      <!-- Conteúdo será inserido via JavaScript -->
    </div>
    <div class="custom-modal-footer">
      <div id="readingsCount" class="modal-footer-left"></div>
      <button class="custom-close-btn">Fechar</button>
    </div>
  </div>
</div>

{% if current_user and current_user.is_admin %}
<!-- Modal de Parâmetros -->
<div id="parametroModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Gerenciar Parâmetros</h3>
    </div>
    <div class="custom-modal-body">
      <div class="parametro-filters">
        <div class="form-group">
          <label>Empresa:</label>
          <select id="empresaSelect" class="form-control">
            <option value="">Selecione uma empresa</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lote:</label>
          <select id="loteSelect" class="form-control" disabled>
            <option value="">Selecione um lote</option>
          </select>
        </div>
        <div class="button-group">
          <button id="btnBuscarParametros" class="custom-save-btn">
            Buscar Parâmetros
          </button>
          <button id="btnNovoParametro" class="custom-save-btn">
            Novo Parâmetro
          </button>
          <button id="btnFecharParametros" class="custom-close-btn">
            Fechar
          </button>
        </div>
      </div>

      <form id="parametroForm" style="display: none">
        <input type="hidden" name="id" />

        <div class="form-group">
          <label>Empresa *</label>
          <input type="text" name="empresa" required />
        </div>

        <div class="form-group">
          <label>Lote *</label>
          <input type="text" name="lote" required />
        </div>

        <div class="form-group">
          <label>Temperatura Ideal (°C) *</label>
          <input type="number" step="0.1" name="temp_ideal" required />
        </div>

        <div class="form-group">
          <label>Umidade Ideal (%) *</label>
          <input type="number" step="0.1" name="umid_ideal" required />
        </div>

        <div class="form-group">
          <label>Pressão Ideal (hPa) *</label>
          <input type="number" step="0.1" name="pressao_ideal" />
        </div>

        <div class="form-group">
          <label>Lumens *</label>
          <input type="number" step="1" name="lumens" />
        </div>

        <div class="form-group">
          <label>ID da Sala *</label>
          <input type="number" name="id_sala" />
        </div>

        <div class="form-group">
          <label>Estágio do Ovo</label>
          <input type="number" name="estagio_ovo" />
        </div>

        <div class="button-group">
          <button type="submit" class="custom-save-btn">Salvar</button>
          <button type="button" id="btnCancelar" class="custom-close-btn">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %} {{ super() }}
<script>
  // Variáveis globais
  const IS_ADMIN = {{ current_user.is_admin|lower if current_user else 'false' }};
  let tempChart, umidChart, pressChart;

  // Inicialização quando a página carrega
  document.addEventListener("DOMContentLoaded", function () {
      const token = localStorage.getItem("embryotech_token");
      if (!token) {
          handleLogout();
          return;
      }

      setupDashboard();
  });

  function setupDashboard() {
      setupEventListeners();
      setupCharts();
      if (IS_ADMIN) {
          setupParametroModal();
      }
      initLoteFilter();
      fetchReadings();
  }

  function setupEventListeners() {
      const logoutBtn = document.getElementById("logoutBtn");
      const showHistoryBtn = document.getElementById("showHistoryBtn");

      if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
      if (showHistoryBtn) showHistoryBtn.addEventListener("click", showHistoryModal);
  }

  function setupCharts() {
      tempChart = new Chart(document.getElementById("tempChart"), {
          type: "line",
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false },
      });

      umidChart = new Chart(document.getElementById("umidChart"), {
          type: "line",
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false },
      });

      pressChart = new Chart(document.getElementById("pressChart"), {
          type: "line",
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false },
      });
  }

  async function handleLogout() {
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
          logoutBtn.textContent = "Saindo...";
          logoutBtn.disabled = true;
      }

      try {
          // Chama endpoint de logout para registrar o log
          const token = localStorage.getItem("embryotech_token");
          if (token) {
              await fetch("{{ url_for('api_logout') }}", {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` }
              });
          }
      } catch (error) {
          console.log("Erro ao registrar logout:", error);
      }

      await new Promise((resolve) => setTimeout(resolve, 300));
      localStorage.removeItem("embryotech_token");
      window.location.href = "{{ url_for('login') }}?logout=success";
  }

  // Função de carregamento de leituras
  async function fetchReadings(lote = "") {
      try {
          const token = localStorage.getItem("embryotech_token");
          let url = "{{ url_for('api_listar_leituras') }}";

          if (lote) {
              url += `?lote=${encodeURIComponent(lote)}`;
          }

          const response = await fetch(url, {
              headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

          let readings = await response.json();

          // Processamento das datas
          readings = readings.map((r) => ({
              ...r,
              data_inicial: r.data_inicial ? new Date(r.data_inicial) : null,
              data_final: r.data_final ? new Date(r.data_final) : null,
          }));

          readings.sort((a, b) => {
              const dateA = a.data_inicial ? new Date(a.data_inicial) : new Date(0);
              const dateB = b.data_inicial ? new Date(b.data_inicial) : new Date(0);
              return dateB - dateA;
          });

          if (readings.length > 0) {
              updateLastReading(readings[0]);
              updateCharts([...readings].reverse());
          } else {
              updateLastReading(null);
              updateCharts([]);
          }
      } catch (error) {
          console.error("Erro ao buscar leituras:", error);
          showError(`Erro ao carregar leituras: ${error.message}`);
      }
  }

  async function initLoteFilter() {
      try {
          const token = localStorage.getItem("embryotech_token");
          const response = await fetch("{{ url_for('api_get_lotes') }}", {
              headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Erro ao carregar lotes");

          const lotes = await response.json();
          const loteFilter = document.getElementById("loteFilter");

          loteFilter.innerHTML = '<option value="">Todos os Lotes</option>';
          lotes.forEach((lote) => {
              const option = document.createElement("option");
              option.value = lote;
              option.textContent = lote;
              loteFilter.appendChild(option);
          });

          loteFilter.addEventListener("change", async () => {
              const loteSelecionado = loteFilter.value;
              const loteLabel = document.getElementById("loteLabel");
              loteLabel.textContent = loteSelecionado ? `Lote: ${loteSelecionado}` : "Lote: Todos";
              await fetchReadings(loteSelecionado);
          });
      } catch (error) {
          console.error("Erro ao carregar lotes:", error);
          showError("Erro ao carregar lista de lotes");
      }
  }

  function updateLastReading(reading) {
      const lastReadingContainer = document.getElementById("lastReadingContainer");
      if (!lastReadingContainer) return;

      if (!reading) {
          lastReadingContainer.innerHTML = `
              <div class="reading-data">
                  <p>Nenhuma leitura disponível para o lote selecionado</p>
              </div>
          `;
          return;
      }

      lastReadingContainer.innerHTML = `
          <div class="reading-data">
              <p><strong>Data/Hora:</strong> ${formatDate(reading.data_inicial)}</p>
              <p><strong>Temperatura:</strong> ${reading.temperatura} °C</p>
              <p><strong>Umidade:</strong> ${reading.umidade} %</p>
              <p><strong>Pressão:</strong> ${reading.pressao} hPa</p>
              <p><strong>Lote:</strong> ${reading.lote || "N/A"}</p>
          </div>
      `;
  }

  function updateCharts(readings) {
      readings.sort((a, b) => new Date(a.data_inicial) - new Date(b.data_inicial));
      const labels = readings.map((r) => formatDate(r.data_inicial, true));
      const temps = readings.map((r) => r.temperatura);
      const umids = readings.map((r) => r.umidade);
      const presses = readings.map((r) => r.pressao);

      updateChart(tempChart, labels, temps, "Temperatura (°C)", "rgba(255, 99, 132, 0.8)");
      updateChart(umidChart, labels, umids, "Umidade (%)", "rgba(54, 162, 235, 0.8)");
      updateChart(pressChart, labels, presses, "Pressão (hPa)", "rgba(3, 62, 253, 0.8)");
  }

  function updateChart(chart, labels, data, label, color) {
      chart.data.labels = labels;
      chart.data.datasets = [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color.replace("0.8", "0.2"),
          tension: 0.1,
          fill: true,
      }];
      chart.update();
  }

  function showHistoryModal() {
      const modal = document.getElementById("customModal");
      const loteSelecionado = document.getElementById("loteFilter").value;

      modal.style.display = "flex";

      setTimeout(() => {
          fetchHistoryReadings(loteSelecionado);
      }, 50);

      const closeButtons = modal.querySelectorAll(".custom-close-btn");
      closeButtons.forEach((btn) => {
          if (!btn.dataset.listenerAttached) {
              btn.addEventListener("click", () => {
                  modal.style.display = "none";
              });
              btn.dataset.listenerAttached = "true";
          }
      });

      if (!modal.dataset.listenerAttached) {
          modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                  modal.style.display = "none";
              }
          });
          modal.dataset.listenerAttached = "true";
      }
  }

  async function fetchHistoryReadings(lote = "") {
      try {
          const token = localStorage.getItem("embryotech_token");
          const container = document.getElementById("readingsListContainer");

          if (!container) return;

          container.innerHTML = "<p>Carregando histórico...</p>";

          let url = "{{ url_for('api_listar_leituras') }}";
          if (lote) {
              url += `?lote=${encodeURIComponent(lote)}`;
          }

          const response = await fetch(url, {
              headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Erro ao carregar histórico");

          let readings = await response.json();
          readings = readings.map((r) => ({
              ...r,
              data_inicial: r.data_inicial ? new Date(r.data_inicial) : null,
              data_final: r.data_final ? new Date(r.data_final) : null,
          }));

          readings.sort((a, b) => new Date(b.data_inicial) - new Date(a.data_inicial));

          updateReadingsList(readings);
          updateReadingsCount(readings.length);
      } catch (error) {
          console.error("Erro em fetchHistoryReadings:", error);
          const container = document.getElementById("readingsListContainer");
          if (container) {
              container.innerHTML = `<p class="error">Erro ao carregar histórico: ${error.message}</p>`;
          }
          showError("Erro ao carregar histórico de leituras");
      }
  }

  function updateReadingsList(readings) {
      const container = document.getElementById("readingsListContainer");
      if (!container) return;

      if (!readings || readings.length === 0) {
          container.innerHTML = `
              <div class="empty-state">
                  <i class="fas fa-clipboard-list"></i>
                  <p>Nenhuma leitura encontrada</p>
              </div>
          `;
          return;
      }

      container.innerHTML = `
          <div class="readings-grid">
              ${readings.map(reading => `
                  <div class="reading-item">
                      <p><strong>Data:</strong> ${formatDate(reading.data_inicial)}</p>
                      <p><strong>Temperatura:</strong> ${reading.temperatura} °C</p>
                      <p><strong>Umidade:</strong> ${reading.umidade} %</p>
                      <p><strong>Pressão:</strong> ${reading.pressao} hPa</p>
                      ${reading.lote ? `<p><strong>Lote:</strong> ${reading.lote}</p>` : ""}
                  </div>
              `).join("")}
          </div>
      `;
  }

  function updateReadingsCount(count) {
      const countElement = document.getElementById("readingsCount");
      if (countElement) {
          countElement.innerHTML = `<strong>Total de leituras:</strong> ${count}`;
      }
  }

  function formatDate(dateString, short = false) {
      if (!dateString) return "N/A";

      const date = new Date(dateString);
      const options = {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
      };

      if (short) {
          return `${date.toLocaleDateString("pt-BR")} ${date.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: false,
          })}`;
      }

      return date.toLocaleString("pt-BR", options);
  }

  // Setup do modal de parâmetros (apenas para admin)
  function setupParametroModal() {
      // Implementação do modal de parâmetros...
      // (Código similar ao original, adaptado para Flask)
  }
</script>
{% endblock %}
