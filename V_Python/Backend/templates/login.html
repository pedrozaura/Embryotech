{% extends "base.html" %} {% block title %}Embryotech - Login{% endblock %} {%
block content %}
<div class="login-container">
  <h1>
    <img
      src="{{ url_for('static', filename='images/logo-icon.png') }}"
      alt="Ícone"
      class="logo-icon"
    />
    OUTSIDE<br /><span>EMBRYOTECH</span>
  </h1>

  {% if logout_success %}
  <div class="logout-message" style="display: block">
    Você saiu do sistema com sucesso.
  </div>
  {% endif %}

  <form id="loginForm">
    <div class="form-group">
      <label for="username">Usuário</label>
      <input type="text" id="username" name="username" required />
    </div>

    <div class="form-group">
      <label for="password">Senha</label>
      <input type="password" id="password" name="password" required />
    </div>

    <button type="submit">LOGIN</button>
  </form>

  <div class="login-footer">Outside Agrotech 2025</div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("loginForm");

    // Verificar e exibir mensagens de expiração
    const urlParams = new URLSearchParams(window.location.search);
    const expired = urlParams.get("expired");
    const reason = urlParams.get("reason");

    if (expired === "true") {
      const messages = {
        "Token expirado":
          "Sua sessão expirou. Por favor, faça login novamente.",
        "Sessão expirada por inatividade":
          "Sua sessão foi encerrada por inatividade (15 minutos sem uso). Por favor, faça login novamente.",
        "Credenciais inválidas":
          "Suas credenciais são inválidas. Por favor, faça login novamente.",
        default: "Sua sessão expirou. Por favor, faça login novamente.",
      };

      const message = messages[reason] || messages["default"];
      showError(message, true);

      // Limpar URL sem recarregar a página
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Se já tiver token válido, verificar antes de redirecionar
    const token = localStorage.getItem("embryotech_token");
    if (token) {
      // Verificar se o token ainda é válido
      validateTokenAndRedirect(token);
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const submitBtn = loginForm.querySelector('button[type="submit"]');

      if (!username || !password) {
        showError("Por favor, preencha todos os campos.", true);
        return;
      }

      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Autenticando...";

      try {
        const response = await fetch("{{ url_for('api_login') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem("embryotech_token", data.token);

          // Aguardar um pouco antes de redirecionar
          await new Promise((resolve) => setTimeout(resolve, 300));

          window.location.href = "{{ url_for('dashboard') }}";
        } else {
          handleLoginError(response.status);
        }
      } catch (error) {
        console.error("Erro no login:", error);
        showError(
          "Não foi possível conectar ao servidor. Verifique sua conexão.",
          true
        );
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    function handleLoginError(status) {
      switch (status) {
        case 400:
          showError("Nome de usuário e senha são obrigatórios", true);
          break;
        case 401:
          showError("Usuário ou senha incorretos", true);
          break;
        case 500:
          showError("Problema no servidor. Tente novamente mais tarde.", true);
          break;
        default:
          showError("Erro ao fazer login", true);
      }
    }

    // Função para validar token antes de redirecionar
    async function validateTokenAndRedirect(token) {
      try {
        // Tentar decodificar o token
        const payload = JSON.parse(atob(token.split(".")[1]));

        if (!payload || !payload.exp) {
          // Token sem expiração, remover
          localStorage.removeItem("embryotech_token");
          return;
        }

        const now = Math.floor(Date.now() / 1000);
        const expiresIn = payload.exp - now;

        // Se o token expirou, remover e não redirecionar
        if (expiresIn < 30) {
          localStorage.removeItem("embryotech_token");
          showError(
            "Sua sessão anterior expirou. Por favor, faça login novamente.",
            true
          );
          return;
        }

        // Token válido, redirecionar
        window.location.href = "{{ url_for('dashboard') }}";
      } catch (e) {
        // Token inválido, remover
        console.error("Token inválido:", e);
        localStorage.removeItem("embryotech_token");
      }
    }
  });
</script>
{% endblock %}
