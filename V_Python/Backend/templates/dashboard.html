{% extends "base.html" %} {% block title %}Embryotech - Dashboard{% endblock %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<header>
  <div class="header-content">
    <img
      src="{{ url_for('static', filename='images/logo-icon.png') }}"
      alt="Logo Embryotech"
      class="header-logo"
    />
    <h1>Dashboard Embryotech</h1>
  </div>
  <button id="logoutBtn">Sair</button>
</header>

<main>
  <section class="last-reading">
    <h2>칔ltima Leitura</h2>
    <div id="lastReadingContainer" class="reading-card">
      <p>Carregando 칰ltima leitura...</p>
    </div>
  </section>

  <!-- Bot칫es: Hist칩rico e Par칙metros -->
  <div class="button-group">
    <button id="showHistoryBtn">Hist칩rico</button>
    <button id="btnParametros" style="display: none">
      Gerenciar Par칙metros
    </button>
    <button id="btnRelatorios" style="display: none">Relat칩rios</button>
    <button id="btnUsuarios" style="display: none">Gerenciar Usu치rios</button>
  </div>

  <section class="charts-section">
    <h2>An치lise Gr치fica</h2>
    <div class="chart-container">
      <div class="lote-selector">
        <label for="loteFilter">Selecione o Lote:</label>
        <select id="loteFilter" class="form-control">
          <option value="">Todos os Lotes</option>
          <!-- Op칞칫es ser칚o preenchidas via JavaScript -->
        </select>
      </div>
      <h3 id="loteLabel">Lote: Selecione um lote para visualizar os dados</h3>
      <div class="chart-row">
        <div class="chart-wrapper">
          <h4>Temperatura (춿C)</h4>
          <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-wrapper">
          <h4>Umidade (%)</h4>
          <canvas id="umidChart"></canvas>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-wrapper">
          <h4>Press칚o (hPa)</h4>
          <canvas id="pressChart"></canvas>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal de Hist칩rico -->
<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Hist칩rico de Leituras</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body" id="readingsListContainer">
      <!-- Conte칰do ser치 inserido via JavaScript -->
    </div>
    <div class="custom-modal-footer">
      <div id="readingsCount" class="modal-footer-left"></div>
      <button class="custom-close-btn">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal de Par칙metros -->
<div id="parametroModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Gerenciar Par칙metros</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="parametro-filters">
        <div class="form-group">
          <label>Empresa:</label>
          <select id="empresaSelect" class="form-control">
            <option value="">Selecione uma empresa</option>
          </select>
        </div>
        <div class="form-group">
          <label>Lote:</label>
          <select id="loteSelect" class="form-control" disabled>
            <option value="">Selecione um lote</option>
          </select>
        </div>
        <div class="button-group">
          <button id="btnBuscarParametros" class="custom-save-btn">
            Buscar Par칙metros
          </button>
          <button id="btnNovoParametro" class="custom-save-btn">
            Novo Par칙metro
          </button>
          <button id="btnFecharParametros" class="custom-close-btn">
            Fechar
          </button>
        </div>
      </div>

      <!-- 츼rea para exibir par칙metros encontrados -->
      <div id="parametrosEncontrados" style="display: none; margin-top: 20px">
        <h4>Par칙metros Encontrados:</h4>
        <div id="listaParametros">
          <!-- Par칙metros ser칚o listados aqui -->
        </div>
      </div>

      <form id="parametroForm" style="display: none">
        <input type="hidden" name="id" />

        <div class="form-group">
          <label>Empresa *</label>
          <input type="text" name="empresa" required />
        </div>

        <div class="form-group">
          <label>Lote *</label>
          <input type="text" name="lote" required />
        </div>

        <div class="form-group">
          <label>Temperatura Ideal (춿C) *</label>
          <input type="number" step="0.1" name="temp_ideal" required />
        </div>

        <div class="form-group">
          <label>Umidade Ideal (%) *</label>
          <input type="number" step="0.1" name="umid_ideal" required />
        </div>

        <div class="form-group">
          <label>Press칚o Ideal (hPa) *</label>
          <input type="number" step="0.1" name="pressao_ideal" />
        </div>

        <div class="form-group">
          <label>Lumens *</label>
          <input type="number" step="1" name="lumens" />
        </div>

        <div class="form-group">
          <label>ID da Sala *</label>
          <input type="number" name="id_sala" />
        </div>

        <div class="form-group">
          <label>Est치gio do Ovo</label>
          <input type="number" name="estagio_ovo" />
        </div>

        <div class="button-group">
          <button type="submit" class="custom-save-btn">Salvar</button>
          <button type="button" id="btnCancelar" class="custom-close-btn">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Relat칩rios -->
<div id="relatoriosModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Relat칩rios do Sistema</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="relatorios-menu">
        <div class="relatorio-card" onclick="abrirRelatorioAuditoria()">
          <h4>游늵 Auditoria de Acessos</h4>
          <p>Visualizar logs de acesso por usu치rio, data e hora</p>
        </div>
        <div class="relatorio-card" onclick="abrirRelatorioLeituras()">
          <h4>游늳 Relat칩rio de Leituras</h4>
          <p>Filtrar leituras por lote e per칤odo</p>
        </div>
        <div class="relatorio-card" onclick="abrirRelatorioUsuarios()">
          <h4>游논 Relat칩rio de Usu치rios</h4>
          <p>Lista completa de usu치rios do sistema</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Auditoria -->
<div id="auditoriaModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Auditoria de Acessos</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="filtros-auditoria">
        <div class="form-row">
          <div class="form-group">
            <label>Usu치rio:</label>
            <select id="filtroUsuario" class="form-control">
              <option value="">Todos os usu치rios</option>
            </select>
          </div>
          <div class="form-group">
            <label>Data In칤cio:</label>
            <input type="date" id="dataInicio" class="form-control" />
          </div>
          <div class="form-group">
            <label>Data Fim:</label>
            <input type="date" id="dataFim" class="form-control" />
          </div>
        </div>
        <div class="button-group">
          <button onclick="buscarAuditoria()" class="custom-save-btn">
            Buscar
          </button>
          <button onclick="exportarAuditoriaPDF()" class="custom-save-btn">
            Exportar PDF
          </button>
        </div>
      </div>

      <div id="resultadosAuditoria" class="resultados-relatorio">
        <!-- Resultados ser칚o carregados aqui -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de Relat칩rio de Leituras -->
<div id="leiturasRelatorioModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Relat칩rio de Leituras</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="filtros-leituras">
        <div class="form-row">
          <div class="form-group">
            <label>Lote:</label>
            <select id="filtroLoteRelatorio" class="form-control">
              <option value="">Todos os lotes</option>
            </select>
          </div>
          <div class="form-group">
            <label>Data In칤cio:</label>
            <input type="date" id="dataInicioLeituras" class="form-control" />
          </div>
          <div class="form-group">
            <label>Data Fim:</label>
            <input type="date" id="dataFimLeituras" class="form-control" />
          </div>
        </div>
        <div class="button-group">
          <button onclick="buscarRelatorioLeituras()" class="custom-save-btn">
            Buscar
          </button>
          <button onclick="exportarLeiturasPDF()" class="custom-save-btn">
            Exportar PDF
          </button>
        </div>
      </div>

      <div id="resultadosLeituras" class="resultados-relatorio">
        <!-- Resultados ser칚o carregados aqui -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de Relat칩rio de Usu치rios -->
<div id="usuariosRelatorioModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Relat칩rio de Usu치rios</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="filtros-leituras">
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Usu치rio:</label>
            <select id="filtroTipoUsuario" class="form-control">
              <option value="">Todos os tipos</option>
              <option value="admin">Administradores</option>
              <option value="user">Usu치rios Comuns</option>
            </select>
          </div>
        </div>
        <div class="button-group">
          <button onclick="buscarRelatorioUsuarios()" class="custom-save-btn">
            Buscar
          </button>
          <button onclick="exportarUsuariosPDF()" class="custom-save-btn">
            Exportar PDF
          </button>
        </div>
      </div>

      <div id="resultadosUsuariosRelatorio" class="resultados-relatorio">
        <!-- Resultados ser칚o carregados aqui -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de Gerenciamento de Usu치rios -->
<div id="usuariosModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h3>Gerenciar Usu치rios</h3>
      <span class="custom-close-btn">&times;</span>
    </div>
    <div class="custom-modal-body">
      <div class="usuarios-lista">
        <h4>Lista de Usu치rios</h4>
        <div id="tabelaUsuarios">
          <!-- Tabela ser치 carregada via JavaScript -->
        </div>

        <div class="button-group" style="margin-top: 20px">
          <button
            onclick="abrirFormularioCadastroUsuario()"
            class="custom-save-btn"
          >
            Cadastrar Novo Usu치rio
          </button>
          <button
            onclick="abrirFormularioAlterarSenha()"
            class="custom-save-btn"
          >
            Alterar Senha de Usu치rio
          </button>
        </div>
      </div>

      <!-- Formul치rio de cadastro de novo usu치rio -->
      <div
        id="formCadastroUsuario"
        style="
          display: none;
          margin-top: 30px;
          border-top: 2px solid #25691b;
          padding-top: 20px;
          background-color: #f8f9fa;
          padding: 20px;
          border-radius: 8px;
        "
      >
        <h4>Cadastrar Novo Usu치rio</h4>
        <form id="cadastroUsuarioForm">
          <div class="form-group">
            <label>Nome de Usu치rio:</label>
            <input
              type="text"
              id="novoUsername"
              class="form-control"
              required
              minlength="3"
              placeholder="Digite o nome de usu치rio"
            />
          </div>

          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="novoEmail"
              class="form-control"
              required
              placeholder="Digite o email do usu치rio"
            />
          </div>

          <div class="form-group">
            <label>Senha:</label>
            <input
              type="password"
              id="novoPasswordUsuario"
              class="form-control"
              required
              minlength="6"
              placeholder="Digite a senha (m칤nimo 6 caracteres)"
            />
          </div>

          <div class="form-group">
            <label>Confirmar Senha:</label>
            <input
              type="password"
              id="confirmarPasswordUsuario"
              class="form-control"
              required
              minlength="6"
              placeholder="Confirme a senha"
            />
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center">
              <input
                type="checkbox"
                id="novoUsuarioAdmin"
                style="margin-right: 8px; transform: scale(1.2)"
              />
              Tornar este usu치rio administrador
            </label>
          </div>

          <div class="button-group">
            <button type="submit" class="custom-save-btn">
              Cadastrar Usu치rio
            </button>
            <button
              type="button"
              onclick="cancelarCadastroUsuario()"
              class="custom-close-btn"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- Formul치rio de altera칞칚o de senha -->
      <div
        id="formAlterarSenha"
        style="
          display: none;
          margin-top: 30px;
          border-top: 1px solid #eee;
          padding-top: 20px;
        "
      >
        <h4>Alterar Senha do Usu치rio</h4>
        <form id="alterarSenhaForm">
          <div class="form-group">
            <label>Usu치rio:</label>
            <select id="selectUsuarioSenha" class="form-control" required>
              <option value="">Selecione um usu치rio</option>
            </select>
          </div>

          <div class="form-group">
            <label>Nova Senha:</label>
            <input
              type="password"
              id="novaSenha"
              class="form-control"
              required
              minlength="6"
            />
          </div>

          <div class="form-group">
            <label>Confirmar Nova Senha:</label>
            <input
              type="password"
              id="confirmarSenha"
              class="form-control"
              required
              minlength="6"
            />
          </div>

          <div class="button-group">
            <button type="submit" class="custom-save-btn">Alterar Senha</button>
            <button
              type="button"
              onclick="cancelarAlteracaoSenha()"
              class="custom-close-btn"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %} {{ super() }}
<script>
  // ============================================
  // SISTEMA DE VALIDA칂츾O DE TOKEN E TIMEOUT
  // ============================================

  // Configura칞칫es de timeout
  const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutos
  let inactivityTimer = null;
  let lastActivityTime = Date.now();

  // Vari치veis globais
  let IS_ADMIN = false;
  let tempChart, umidChart, pressChart;
  let USER_DATA = null;

  // Fun칞칚o para verificar se o token est치 expirado
  function isTokenExpired(token) {
    try {
      const payload = parseJwt(token);
      if (!payload || !payload.exp) {
        console.log("Token sem data de expira칞칚o");
        return true;
      }

      const now = Math.floor(Date.now() / 1000);
      const expiresIn = payload.exp - now;

      console.log(`Token expira em ${expiresIn} segundos`);
      return expiresIn < 30;
    } catch (e) {
      console.error("Erro ao verificar expira칞칚o do token:", e);
      return true;
    }
  }

  // Fun칞칚o para validar token com o servidor
  async function validateToken() {
    const token = localStorage.getItem("embryotech_token");

    if (!token) {
      console.log("Nenhum token encontrado");
      return false;
    }

    if (isTokenExpired(token)) {
      console.log("Token expirado");
      return false;
    }

    try {
      const response = await fetch("/api/usuarios", {
        method: "HEAD",
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.status === 401) {
        console.log("Token inv치lido ou expirado (401)");
        return false;
      }

      return response.ok;
    } catch (error) {
      console.error("Erro ao validar token:", error);
      return false;
    }
  }

  // Fun칞칚o para logout for칞ado
  async function forceLogout(reason = "Token expirado") {
    console.log(`Logout for칞ado: ${reason}`);

    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
    }

    localStorage.removeItem("embryotech_token");
    window.location.href = `{{ url_for('login') }}?expired=true&reason=${encodeURIComponent(
      reason
    )}`;
  }

  // Resetar timer de inatividade
  function resetInactivityTimer() {
    lastActivityTime = Date.now();

    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
    }

    inactivityTimer = setTimeout(() => {
      forceLogout("Sess칚o expirada por inatividade");
    }, INACTIVITY_TIMEOUT);
  }

  // Monitorar atividade do usu치rio
  function setupActivityMonitoring() {
    const events = [
      "mousedown",
      "mousemove",
      "keypress",
      "scroll",
      "touchstart",
      "click",
    ];

    events.forEach((event) => {
      document.addEventListener(event, resetInactivityTimer, true);
    });

    resetInactivityTimer();
    console.log(
      `Monitoramento de inatividade ativado (${
        INACTIVITY_TIMEOUT / 60000
      } minutos)`
    );
  }

  // Interceptor global para requisi칞칫es fetch
  const originalFetch = window.fetch;
  window.fetch = async function (...args) {
    try {
      const response = await originalFetch.apply(this, args);

      if (response.status === 401) {
        console.log("Requisi칞칚o retornou 401 - Token inv치lido");
        forceLogout("Credenciais inv치lidas");
        throw new Error("Token inv치lido");
      }

      return response;
    } catch (error) {
      throw error;
    }
  };

  // Fun칞칚o para verificar se 칠 admin via token
  function parseJwt(token) {
    try {
      return JSON.parse(atob(token.split(".")[1]));
    } catch (e) {
      console.error("Erro ao fazer parse do JWT:", e);
      return null;
    }
  }

  // DEBUG: Fun칞칚o para verificar usu치rio no banco via API
  async function verificarUsuarioAdmin() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/usuarios", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const usuarios = await response.json();
        const payload = parseJwt(token);
        if (payload) {
          const usuarioAtual = usuarios.find((u) => u.id === payload.id);
          if (usuarioAtual) {
            console.log("Usu치rio atual encontrado:", usuarioAtual);
            return usuarioAtual.is_admin;
          }
        }
      }
    } catch (error) {
      console.error("Erro ao verificar usu치rio admin:", error);
    }
    return false;
  }

  // Fun칞칚o de inicializa칞칚o com valida칞칚o
  async function initializeDashboard() {
    console.log("=== INICIALIZANDO DASHBOARD ===");

    const token = localStorage.getItem("embryotech_token");

    if (!token) {
      console.log("Nenhum token - redirecionando para login");
      window.location.href = "{{ url_for('login') }}";
      return false;
    }

    const container = document.getElementById("lastReadingContainer");
    if (container) {
      container.innerHTML = "<p>Validando sess칚o...</p>";
    }

    const isValid = await validateToken();

    if (!isValid) {
      console.log("Token inv치lido - for칞ando logout");
      await forceLogout("Sess칚o expirada");
      return false;
    }

    console.log("Token v치lido - prosseguindo");

    const payload = parseJwt(token);
    if (payload) {
      IS_ADMIN = payload.is_admin === true;
      console.log("IS_ADMIN:", IS_ADMIN);
    }

    if (!IS_ADMIN) {
      IS_ADMIN = await verificarUsuarioAdmin();
    }

    setupActivityMonitoring();
    setupDashboard();

    console.log("=== DASHBOARD INICIALIZADO ===");
    return true;
  }

  // Inicializa칞칚o quando a p치gina carrega
  document.addEventListener("DOMContentLoaded", async function () {
    await initializeDashboard();
  });

  // ============================================
  // FUN칂칏ES DO DASHBOARD
  // ============================================

  function setupDashboard() {
    setupEventListeners();
    setupCharts();
    setupAdminControls();
    initLoteFilter();
    updateLastReading(null);
  }

  function setupAdminControls() {
    const btnParametros = document.getElementById("btnParametros");
    const btnRelatorios = document.getElementById("btnRelatorios");
    const btnUsuarios = document.getElementById("btnUsuarios");

    console.log("=== DEBUG ADMIN CONTROLS ===");
    console.log("IS_ADMIN:", IS_ADMIN);

    if (IS_ADMIN) {
      console.log("Configurando controles de admin...");

      if (btnParametros) {
        btnParametros.style.display = "inline-block";
        btnParametros.onclick = function (e) {
          e.preventDefault();
          abrirModalParametros();
        };
      }

      if (btnRelatorios) {
        btnRelatorios.style.display = "inline-block";
        btnRelatorios.onclick = function (e) {
          e.preventDefault();
          abrirModalRelatorios();
        };
      }

      if (btnUsuarios) {
        btnUsuarios.style.display = "inline-block";
        btnUsuarios.onclick = function (e) {
          e.preventDefault();
          abrirModalUsuarios();
        };
      }

      setTimeout(() => {
        setupParametroModal();
        setupRelatoriosModal();
        setupUsuariosModal();
      }, 100);
    } else {
      if (btnParametros) btnParametros.style.display = "none";
      if (btnRelatorios) btnRelatorios.style.display = "none";
      if (btnUsuarios) btnUsuarios.style.display = "none";
    }
  }

  function setupEventListeners() {
    const logoutBtn = document.getElementById("logoutBtn");
    const showHistoryBtn = document.getElementById("showHistoryBtn");

    if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
    if (showHistoryBtn)
      showHistoryBtn.addEventListener("click", showHistoryModal);
  }

  function setupCharts() {
    tempChart = new Chart(document.getElementById("tempChart"), {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Temperatura (춿C)",
            data: [],
            borderColor: "rgba(255, 99, 132, 0.8)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            tension: 0.1,
            fill: true,
          },
        ],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    umidChart = new Chart(document.getElementById("umidChart"), {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Umidade (%)",
            data: [],
            borderColor: "rgba(54, 162, 235, 0.8)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            tension: 0.1,
            fill: true,
          },
        ],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    pressChart = new Chart(document.getElementById("pressChart"), {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Press칚o (hPa)",
            data: [],
            borderColor: "rgba(3, 62, 253, 0.8)",
            backgroundColor: "rgba(3, 62, 253, 0.2)",
            tension: 0.1,
            fill: true,
          },
        ],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });
  }

  async function handleLogout() {
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.textContent = "Saindo...";
      logoutBtn.disabled = true;
    }

    try {
      const token = localStorage.getItem("embryotech_token");
      if (token) {
        await fetch("{{ url_for('api_logout') }}", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
        });
      }
    } catch (error) {
      console.log("Erro ao registrar logout:", error);
    }

    await new Promise((resolve) => setTimeout(resolve, 300));
    localStorage.removeItem("embryotech_token");
    window.location.href = "{{ url_for('login') }}?logout=success";
  }

  // === FUN칂칏ES DE MODAL BASE ===

  function setupModalCloseEvents(modal) {
    if (!modal) return;

    const closeButtons = modal.querySelectorAll(".custom-close-btn");
    closeButtons.forEach((btn) => {
      btn.onclick = function () {
        modal.style.display = "none";
      };
    });

    modal.onclick = function (e) {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    };
  }

  // === FUN칂칏ES DE PAR츽METROS ===

  function abrirModalParametros() {
    const modal = document.getElementById("parametroModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
      carregarEmpresas();

      const filtersSection = document.querySelector(".parametro-filters");
      const parametroForm = document.getElementById("parametroForm");
      const parametrosEncontrados = document.getElementById(
        "parametrosEncontrados"
      );

      if (filtersSection) filtersSection.style.display = "block";
      if (parametroForm) parametroForm.style.display = "none";
      if (parametrosEncontrados) parametrosEncontrados.style.display = "none";
    }
  }

  function setupParametroModal() {
    const btnFechar = document.getElementById("btnFecharParametros");
    const btnNovo = document.getElementById("btnNovoParametro");
    const btnBuscar = document.getElementById("btnBuscarParametros");
    const btnCancelar = document.getElementById("btnCancelar");
    const empresaSelect = document.getElementById("empresaSelect");
    const parametroForm = document.getElementById("parametroForm");

    if (btnFechar) {
      btnFechar.onclick = function () {
        document.getElementById("parametroModal").style.display = "none";
      };
    }

    if (btnNovo) {
      btnNovo.onclick = function () {
        const filtersSection = document.querySelector(".parametro-filters");
        const parametrosEncontrados = document.getElementById(
          "parametrosEncontrados"
        );

        if (filtersSection) filtersSection.style.display = "none";
        if (parametroForm) parametroForm.style.display = "block";
        if (parametrosEncontrados) parametrosEncontrados.style.display = "none";

        parametroForm.reset();
        parametroForm.querySelector("[name='id']").value = "";
      };
    }

    if (btnBuscar) {
      btnBuscar.onclick = async function () {
        await buscarParametros();
      };
    }

    if (btnCancelar) {
      btnCancelar.onclick = function () {
        const filtersSection = document.querySelector(".parametro-filters");
        const parametrosEncontrados = document.getElementById(
          "parametrosEncontrados"
        );

        if (filtersSection) filtersSection.style.display = "block";
        if (parametroForm) parametroForm.style.display = "none";
        if (parametrosEncontrados) parametrosEncontrados.style.display = "none";
      };
    }

    if (empresaSelect) {
      empresaSelect.onchange = async function (e) {
        if (e.target.value) {
          await carregarLotes(e.target.value);
        } else {
          document.getElementById("loteSelect").innerHTML =
            '<option value="">Selecione um lote</option>';
          document.getElementById("loteSelect").disabled = true;
        }
      };
    }

    if (parametroForm) {
      parametroForm.onsubmit = async function (e) {
        e.preventDefault();
        await salvarParametro(e);
      };
    }
  }

  async function buscarParametros() {
    const empresa = document.getElementById("empresaSelect").value;
    const lote = document.getElementById("loteSelect").value;

    if (!empresa || !lote) {
      showError("Por favor, selecione uma empresa e um lote");
      return;
    }

    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch(
        `/api/parametros?empresa=${encodeURIComponent(
          empresa
        )}&lote=${encodeURIComponent(lote)}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (response.ok) {
        const parametros = await response.json();
        exibirParametrosEncontrados(parametros);
      } else {
        const error = await response.json();
        showError("Erro ao buscar par칙metros: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao buscar par칙metros:", error);
      showError("Erro ao buscar par칙metros: " + error.message);
    }
  }

  function exibirParametrosEncontrados(parametros) {
    const container = document.getElementById("parametrosEncontrados");
    const lista = document.getElementById("listaParametros");

    if (parametros.length === 0) {
      lista.innerHTML =
        "<p>Nenhum par칙metro encontrado para esta empresa e lote.</p>";
    } else {
      let html = '<div class="tabela-container">';
      html += '<table class="tabela-relatorio">';
      html +=
        "<thead><tr><th>ID</th><th>Temp. Ideal (춿C)</th><th>Umid. Ideal (%)</th><th>Press칚o Ideal (hPa)</th><th>Lumens</th><th>ID Sala</th><th>Est치gio Ovo</th><th>A칞칫es</th></tr></thead>";
      html += "<tbody>";

      parametros.forEach((param) => {
        html += `<tr>
          <td>${param.id}</td>
          <td>${param.temp_ideal}</td>
          <td>${param.umid_ideal}</td>
          <td>${param.pressao_ideal || "-"}</td>
          <td>${param.lumens || "-"}</td>
          <td>${param.id_sala || "-"}</td>
          <td>${param.estagio_ovo || "-"}</td>
          <td>
            <button onclick="editarParametro(${
              param.id
            })" class="btn-pequeno btn-promover">Editar</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      lista.innerHTML = html;
    }

    container.style.display = "block";
  }

  function editarParametro(id) {
    buscarParametroPorId(id);
  }

  async function buscarParametroPorId(id) {
    try {
      const parametrosEncontrados = document.getElementById(
        "parametrosEncontrados"
      );
      const tabela = parametrosEncontrados.querySelector("table tbody");

      if (tabela) {
        const linhas = tabela.querySelectorAll("tr");
        for (let linha of linhas) {
          const primeiraColuna = linha.querySelector("td");
          if (primeiraColuna && primeiraColuna.textContent == id) {
            const colunas = linha.querySelectorAll("td");
            const parametro = {
              id: id,
              temp_ideal: parseFloat(colunas[1].textContent),
              umid_ideal: parseFloat(colunas[2].textContent),
              pressao_ideal:
                colunas[3].textContent !== "-"
                  ? parseFloat(colunas[3].textContent)
                  : "",
              lumens:
                colunas[4].textContent !== "-"
                  ? parseFloat(colunas[4].textContent)
                  : "",
              id_sala:
                colunas[5].textContent !== "-"
                  ? parseInt(colunas[5].textContent)
                  : "",
              estagio_ovo:
                colunas[6].textContent !== "-" ? colunas[6].textContent : "",
              empresa: document.getElementById("empresaSelect").value,
              lote: document.getElementById("loteSelect").value,
            };

            preencherFormularioEdicao(parametro);
            return;
          }
        }
      }

      showError("Par칙metro n칚o encontrado para edi칞칚o");
    } catch (error) {
      console.error("Erro ao buscar par칙metro:", error);
      showError("Erro ao carregar dados para edi칞칚o");
    }
  }

  function preencherFormularioEdicao(parametro) {
    const filtersSection = document.querySelector(".parametro-filters");
    const parametrosEncontrados = document.getElementById(
      "parametrosEncontrados"
    );
    const parametroForm = document.getElementById("parametroForm");

    if (filtersSection) filtersSection.style.display = "none";
    if (parametrosEncontrados) parametrosEncontrados.style.display = "none";
    if (parametroForm) parametroForm.style.display = "block";

    const form = parametroForm;
    form.querySelector("[name='id']").value = parametro.id;
    form.querySelector("[name='empresa']").value = parametro.empresa;
    form.querySelector("[name='lote']").value = parametro.lote;
    form.querySelector("[name='temp_ideal']").value = parametro.temp_ideal;
    form.querySelector("[name='umid_ideal']").value = parametro.umid_ideal;
    form.querySelector("[name='pressao_ideal']").value =
      parametro.pressao_ideal || "";
    form.querySelector("[name='lumens']").value = parametro.lumens || "";
    form.querySelector("[name='id_sala']").value = parametro.id_sala || "";
    form.querySelector("[name='estagio_ovo']").value =
      parametro.estagio_ovo || "";

    form.querySelector("[name='empresa']").focus();
  }

  async function carregarEmpresas() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/empresas", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const empresas = await response.json();
        const select = document.getElementById("empresaSelect");
        select.innerHTML = '<option value="">Selecione uma empresa</option>';

        empresas.forEach((empresa) => {
          const option = document.createElement("option");
          option.value = empresa;
          option.textContent = empresa;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Erro ao carregar empresas:", error);
      showError("Erro ao carregar lista de empresas");
    }
  }

  async function carregarLotes(empresa) {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch(
        `/api/lotes?empresa=${encodeURIComponent(empresa)}`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (response.ok) {
        const lotes = await response.json();
        const select = document.getElementById("loteSelect");
        select.innerHTML = '<option value="">Selecione um lote</option>';
        select.disabled = false;

        lotes.forEach((lote) => {
          const option = document.createElement("option");
          option.value = lote;
          option.textContent = lote;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Erro ao carregar lotes:", error);
      showError("Erro ao carregar lista de lotes");
    }
  }

  async function salvarParametro(e) {
    const parametroForm = document.getElementById("parametroForm");
    const data = Object.fromEntries(new FormData(parametroForm).entries());

    if (!data.empresa || !data.lote || !data.temp_ideal || !data.umid_ideal) {
      showError("Campos obrigat칩rios faltando");
      return;
    }

    try {
      const token = localStorage.getItem("embryotech_token");
      const method = data.id ? "PUT" : "POST";
      const url = data.id ? `/api/parametros/${data.id}` : `/api/parametros`;

      const response = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          empresa: data.empresa,
          lote: data.lote,
          temp_ideal: parseFloat(data.temp_ideal),
          umid_ideal: parseFloat(data.umid_ideal),
          pressao_ideal: data.pressao_ideal
            ? parseFloat(data.pressao_ideal)
            : null,
          lumens: data.lumens ? parseFloat(data.lumens) : null,
          id_sala: data.id_sala ? parseInt(data.id_sala) : null,
          estagio_ovo: data.estagio_ovo || null,
        }),
      });

      if (response.ok) {
        showMessage("Par칙metros salvos com sucesso!", "success");

        if (data.id) {
          setTimeout(async () => {
            const filtersSection = document.querySelector(".parametro-filters");
            const parametrosEncontrados = document.getElementById(
              "parametrosEncontrados"
            );
            const parametroForm = document.getElementById("parametroForm");

            if (filtersSection) filtersSection.style.display = "block";
            if (parametroForm) parametroForm.style.display = "none";

            await buscarParametros();
          }, 1500);
        } else {
          setTimeout(() => {
            document.getElementById("parametroModal").style.display = "none";
          }, 1500);
        }
      } else {
        const err = await response.json();
        showError("Erro: " + err.message);
      }
    } catch (error) {
      showError("Erro ao salvar par칙metros: " + error.message);
    }
  }

  // === FUN칂칏ES DE RELAT칍RIOS ===

  function abrirModalRelatorios() {
    const modal = document.getElementById("relatoriosModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
    }
  }

  function setupRelatoriosModal() {
    setupModalCloseEvents(document.getElementById("relatoriosModal"));
    setupModalCloseEvents(document.getElementById("auditoriaModal"));
    setupModalCloseEvents(document.getElementById("leiturasRelatorioModal"));
    setupModalCloseEvents(document.getElementById("usuariosRelatorioModal"));
  }

  function abrirRelatorioAuditoria() {
    document.getElementById("relatoriosModal").style.display = "none";
    const modal = document.getElementById("auditoriaModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
      carregarUsuariosAuditoria();
      definirDatasAuditoria();
    }
  }

  function abrirRelatorioLeituras() {
    document.getElementById("relatoriosModal").style.display = "none";
    const modal = document.getElementById("leiturasRelatorioModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
      carregarLotesRelatorio();
      definirDatasLeituras();
    }
  }

  function abrirRelatorioUsuarios() {
    document.getElementById("relatoriosModal").style.display = "none";
    const modal = document.getElementById("usuariosRelatorioModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
      buscarRelatorioUsuarios();
    }
  }

  async function carregarUsuariosAuditoria() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/usuarios", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const usuarios = await response.json();
        const select = document.getElementById("filtroUsuario");
        select.innerHTML = '<option value="">Todos os usu치rios</option>';

        usuarios.forEach((usuario) => {
          const option = document.createElement("option");
          option.value = usuario.id;
          option.textContent = usuario.username;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Erro ao carregar usu치rios:", error);
    }
  }

  async function carregarLotesRelatorio() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/lotes", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const lotes = await response.json();
        const select = document.getElementById("filtroLoteRelatorio");
        select.innerHTML = '<option value="">Todos os lotes</option>';

        lotes.forEach((lote) => {
          const option = document.createElement("option");
          option.value = lote;
          option.textContent = lote;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error("Erro ao carregar lotes:", error);
    }
  }

  function definirDatasAuditoria() {
    const hoje = new Date();
    const umaSemanaAtras = new Date(hoje);
    umaSemanaAtras.setDate(hoje.getDate() - 7);

    document.getElementById("dataInicio").value = umaSemanaAtras
      .toISOString()
      .split("T")[0];
    document.getElementById("dataFim").value = hoje.toISOString().split("T")[0];
  }

  function definirDatasLeituras() {
    const hoje = new Date();
    const umMesAtras = new Date(hoje);
    umMesAtras.setMonth(hoje.getMonth() - 1);

    document.getElementById("dataInicioLeituras").value = umMesAtras
      .toISOString()
      .split("T")[0];
    document.getElementById("dataFimLeituras").value = hoje
      .toISOString()
      .split("T")[0];
  }

  async function buscarAuditoria() {
    const usuarioId = document.getElementById("filtroUsuario").value;
    const dataInicio = document.getElementById("dataInicio").value;
    const dataFim = document.getElementById("dataFim").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "/api/logs?limite=200";

      if (usuarioId) url += `&usuario_id=${usuarioId}`;
      if (dataInicio) url += `&data_inicio=${dataInicio}`;
      if (dataFim) url += `&data_fim=${dataFim}`;

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const logs = await response.json();
        exibirResultadosAuditoria(logs);
      } else {
        showError("Erro ao buscar dados de auditoria");
      }
    } catch (error) {
      console.error("Erro na busca de auditoria:", error);
      showError("Erro ao buscar dados de auditoria");
    }
  }

  function exibirResultadosAuditoria(logs) {
    const container = document.getElementById("resultadosAuditoria");

    if (!logs || logs.length === 0) {
      container.innerHTML =
        '<div class="empty-state"><p>Nenhum log encontrado para os filtros selecionados</p></div>';
      return;
    }

    const html = `
        <div class="relatorio-header">
            <h4>Resultados da Auditoria (${logs.length} registros)</h4>
        </div>
        <div class="tabela-container">
            <table class="tabela-relatorio">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Usu치rio</th>
                        <th>A칞칚o</th>
                        <th>IP</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${logs
                      .map(
                        (log) => `
                        <tr>
                            <td>${formatDate(log.data_hora)}</td>
                            <td>${log.usuario_nome || "An칪nimo"}</td>
                            <td>${log.acao}</td>
                            <td>${log.ip_address || "-"}</td>
                            <td><span class="status-${
                              log.status_code < 400 ? "sucesso" : "erro"
                            }">${log.status_code}</span></td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
  }

  async function buscarRelatorioLeituras() {
    const lote = document.getElementById("filtroLoteRelatorio").value;
    const dataInicio = document.getElementById("dataInicioLeituras").value;
    const dataFim = document.getElementById("dataFimLeituras").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "/api/relatorio/leituras?";

      const params = [];
      if (lote) params.push(`lote=${encodeURIComponent(lote)}`);
      if (dataInicio) params.push(`data_inicio=${dataInicio}`);
      if (dataFim) params.push(`data_fim=${dataFim}`);

      url += params.join("&");

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const leituras = await response.json();
        exibirResultadosLeituras(leituras);
      } else {
        const error = await response.json();
        showError("Erro ao buscar dados de leituras: " + error.message);
      }
    } catch (error) {
      console.error("Erro na busca de leituras:", error);
      showError("Erro ao buscar dados de leituras: " + error.message);
    }
  }

  function exibirResultadosLeituras(leituras) {
    const container = document.getElementById("resultadosLeituras");

    if (!leituras || leituras.length === 0) {
      container.innerHTML =
        '<div class="empty-state"><p>Nenhuma leitura encontrada para os filtros selecionados</p></div>';
      return;
    }

    const html = `
        <div class="relatorio-header">
            <h4>Resultados das Leituras (${leituras.length} registros)</h4>
        </div>
        <div class="tabela-container">
            <table class="tabela-relatorio">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Lote</th>
                        <th>Temperatura (춿C)</th>
                        <th>Umidade (%)</th>
                        <th>Press칚o (hPa)</th>
                    </tr>
                </thead>
                <tbody>
                    ${leituras
                      .map(
                        (leitura) => `
                        <tr>
                            <td>${formatDate(leitura.data_inicial)}</td>
                            <td>${leitura.lote || "-"}</td>
                            <td>${
                              leitura.temperatura
                                ? leitura.temperatura.toFixed(1)
                                : "-"
                            }</td>
                            <td>${
                              leitura.umidade ? leitura.umidade.toFixed(1) : "-"
                            }</td>
                            <td>${
                              leitura.pressao ? leitura.pressao.toFixed(1) : "-"
                            }</td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
  }

  async function buscarRelatorioUsuarios() {
    const tipoUsuario = document.getElementById("filtroTipoUsuario").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/usuarios", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        let usuarios = await response.json();

        if (tipoUsuario === "admin") {
          usuarios = usuarios.filter((u) => u.is_admin);
        } else if (tipoUsuario === "user") {
          usuarios = usuarios.filter((u) => !u.is_admin);
        }

        exibirResultadosUsuarios(usuarios);
      } else {
        const error = await response.json();
        showError("Erro ao buscar dados de usu치rios: " + error.message);
      }
    } catch (error) {
      console.error("Erro na busca de usu치rios:", error);
      showError("Erro ao buscar dados de usu치rios: " + error.message);
    }
  }

  function exibirResultadosUsuarios(usuarios) {
    const container = document.getElementById("resultadosUsuariosRelatorio");

    if (!usuarios || usuarios.length === 0) {
      container.innerHTML =
        '<div class="empty-state"><p>Nenhum usu치rio encontrado para os filtros selecionados</p></div>';
      return;
    }

    const html = `
        <div class="relatorio-header">
            <h4>Resultados dos Usu치rios (${usuarios.length} registros)</h4>
        </div>
        <div class="tabela-container">
            <table class="tabela-relatorio">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome de Usu치rio</th>
                        <th>Email</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody>
                    ${usuarios
                      .map(
                        (usuario) => `
                        <tr>
                            <td>${usuario.id}</td>
                            <td>${usuario.username}</td>
                            <td>${usuario.email}</td>
                            <td><span class="status-${
                              usuario.is_admin ? "sucesso" : "neutro"
                            }">
                                ${
                                  usuario.is_admin
                                    ? "Administrador"
                                    : "Usu치rio Comum"
                                }
                            </span></td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
  }

  // === FUN칂칏ES DE USU츼RIOS ===

  function abrirModalUsuarios() {
    const modal = document.getElementById("usuariosModal");
    if (modal) {
      modal.style.display = "flex";
      setupModalCloseEvents(modal);
      carregarListaUsuarios();
    }
  }

  function setupUsuariosModal() {
    const formAlterarSenha = document.getElementById("alterarSenhaForm");
    if (formAlterarSenha) {
      formAlterarSenha.onsubmit = async function (e) {
        e.preventDefault();
        await alterarSenhaUsuario(e);
      };
    }

    const formCadastroUsuario = document.getElementById("cadastroUsuarioForm");
    if (formCadastroUsuario) {
      formCadastroUsuario.onsubmit = async function (e) {
        e.preventDefault();
        await cadastrarNovoUsuario(e);
      };
    }
  }

  async function carregarListaUsuarios() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("/api/usuarios", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const usuarios = await response.json();
        exibirTabelaUsuarios(usuarios);
        preencherSelectUsuarios(usuarios);
      } else {
        showError("Erro ao carregar usu치rios");
      }
    } catch (error) {
      console.error("Erro ao carregar usu치rios:", error);
      showError("Erro ao carregar usu치rios");
    }
  }

  function exibirTabelaUsuarios(usuarios) {
    const container = document.getElementById("tabelaUsuarios");

    if (!usuarios || usuarios.length === 0) {
      container.innerHTML = "<p>Nenhum usu치rio encontrado</p>";
      return;
    }

    const html = `
        <table class="tabela-relatorio">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome de Usu치rio</th>
                    <th>Email</th>
                    <th>Admin</th>
                    <th>A칞칫es</th>
                </tr>
            </thead>
            <tbody>
                ${usuarios
                  .map(
                    (usuario) => `
                    <tr>
                        <td>${usuario.id}</td>
                        <td>${usuario.username}</td>
                        <td>${usuario.email}</td>
                        <td>
                            <span class="status-${
                              usuario.is_admin ? "sucesso" : "neutro"
                            }">
                                ${usuario.is_admin ? "Sim" : "N칚o"}
                            </span>
                        </td>
                        <td>
                            <button onclick="toggleAdmin(${
                              usuario.id
                            }, ${!usuario.is_admin})" 
                                    class="btn-pequeno ${
                                      usuario.is_admin
                                        ? "btn-remover"
                                        : "btn-promover"
                                    }">
                                ${
                                  usuario.is_admin
                                    ? "Remover Admin"
                                    : "Tornar Admin"
                                }
                            </button>
                        </td>
                    </tr>
                `
                  )
                  .join("")}
            </tbody>
        </table>
    `;

    container.innerHTML = html;
  }

  function preencherSelectUsuarios(usuarios) {
    const select = document.getElementById("selectUsuarioSenha");
    if (!select) return;

    select.innerHTML = '<option value="">Selecione um usu치rio</option>';
    usuarios.forEach((usuario) => {
      const option = document.createElement("option");
      option.value = usuario.id;
      option.textContent = `${usuario.username} (${usuario.email})`;
      select.appendChild(option);
    });
  }

  function abrirFormularioCadastroUsuario() {
    const form = document.getElementById("formCadastroUsuario");
    if (form) {
      form.style.display = "block";
      document.getElementById("novoUsername").value = "";
      document.getElementById("novoEmail").value = "";
      document.getElementById("novoPasswordUsuario").value = "";
      document.getElementById("confirmarPasswordUsuario").value = "";
      document.getElementById("novoUsuarioAdmin").checked = false;
      document.getElementById("novoUsername").focus();
    }
  }

  function cancelarCadastroUsuario() {
    const form = document.getElementById("formCadastroUsuario");
    if (form) {
      form.style.display = "none";
    }
  }

  async function cadastrarNovoUsuario(e) {
    const username = document.getElementById("novoUsername").value.trim();
    const email = document.getElementById("novoEmail").value.trim();
    const password = document.getElementById("novoPasswordUsuario").value;
    const confirmarPassword = document.getElementById(
      "confirmarPasswordUsuario"
    ).value;
    const isAdmin = document.getElementById("novoUsuarioAdmin").checked;

    if (!username || !email || !password) {
      showError("Preencha todos os campos obrigat칩rios");
      return;
    }

    if (username.length < 3) {
      showError("O nome de usu치rio deve ter pelo menos 3 caracteres");
      return;
    }

    if (password.length < 6) {
      showError("A senha deve ter pelo menos 6 caracteres");
      return;
    }

    if (password !== confirmarPassword) {
      showError("As senhas n칚o coincidem");
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showError("Digite um email v치lido");
      return;
    }

    try {
      const token = localStorage.getItem("embryotech_token");

      const response = await fetch("/api/register", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          username: username,
          email: email,
          password: password,
        }),
      });

      if (response.ok) {
        const result = await response.json();

        if (isAdmin) {
          const usuariosResponse = await fetch("/api/usuarios", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (usuariosResponse.ok) {
            const usuarios = await usuariosResponse.json();
            const usuarioCriado = usuarios.find((u) => u.username === username);

            if (usuarioCriado) {
              const adminResponse = await fetch(
                `/api/usuarios/${usuarioCriado.id}/admin`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify({ is_admin: true }),
                }
              );

              if (!adminResponse.ok) {
                console.warn("Usu치rio criado, mas falha ao promover a admin");
              }
            }
          }
        }

        showMessage("Usu치rio cadastrado com sucesso!", "success");

        setTimeout(() => {
          carregarListaUsuarios();
          cancelarCadastroUsuario();
        }, 1500);
      } else {
        const error = await response.json();
        if (
          response.status === 400 &&
          error.message.includes("Username already exists")
        ) {
          showError("Este nome de usu치rio j치 existe. Escolha outro.");
        } else if (
          response.status === 400 &&
          error.message.includes("Email already exists")
        ) {
          showError("Este email j치 est치 cadastrado. Use outro email.");
        } else {
          showError("Erro ao cadastrar usu치rio: " + error.message);
        }
      }
    } catch (error) {
      console.error("Erro ao cadastrar usu치rio:", error);
      showError("Erro ao cadastrar usu치rio: " + error.message);
    }
  }

  function abrirFormularioAlterarSenha() {
    const form = document.getElementById("formAlterarSenha");
    if (form) {
      form.style.display = "block";
      document.getElementById("selectUsuarioSenha").value = "";
      document.getElementById("novaSenha").value = "";
      document.getElementById("confirmarSenha").value = "";
    }
  }

  function cancelarAlteracaoSenha() {
    const form = document.getElementById("formAlterarSenha");
    if (form) {
      form.style.display = "none";
    }
  }

  async function toggleAdmin(usuarioId, tornarAdmin) {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch(`/api/usuarios/${usuarioId}/admin`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ is_admin: tornarAdmin }),
      });

      if (response.ok) {
        showMessage(
          tornarAdmin
            ? "Usu치rio promovido a admin!"
            : "Privil칠gios de admin removidos!",
          "success"
        );
        carregarListaUsuarios();
      } else {
        const error = await response.json();
        showError("Erro: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao alterar privil칠gios:", error);
      showError("Erro ao alterar privil칠gios do usu치rio");
    }
  }

  async function alterarSenhaUsuario(e) {
    const usuarioId = document.getElementById("selectUsuarioSenha").value;
    const novaSenha = document.getElementById("novaSenha").value;
    const confirmarSenha = document.getElementById("confirmarSenha").value;

    if (!usuarioId) {
      showError("Selecione um usu치rio");
      return;
    }

    if (novaSenha.length < 6) {
      showError("A senha deve ter pelo menos 6 caracteres");
      return;
    }

    if (novaSenha !== confirmarSenha) {
      showError("As senhas n칚o coincidem");
      return;
    }

    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch(`/api/usuarios/${usuarioId}/senha`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ nova_senha: novaSenha }),
      });

      if (response.ok) {
        showMessage("Senha alterada com sucesso!", "success");
        cancelarAlteracaoSenha();
      } else {
        const error = await response.json();
        showError("Erro: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao alterar senha:", error);
      showError("Erro ao alterar senha do usu치rio");
    }
  }

  // === FUN칂칏ES DE EXPORTA칂츾O PDF ===

  async function exportarAuditoriaPDF() {
    const usuarioId = document.getElementById("filtroUsuario").value;
    const dataInicio = document.getElementById("dataInicio").value;
    const dataFim = document.getElementById("dataFim").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "/api/relatorio/auditoria/pdf?";

      const params = [];
      if (usuarioId) params.push(`usuario_id=${usuarioId}`);
      if (dataInicio) params.push(`data_inicio=${dataInicio}`);
      if (dataFim) params.push(`data_fim=${dataFim}`);

      url += params.join("&");

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = downloadUrl;
        link.download = "auditoria_embryotech.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);

        showMessage("PDF exportado com sucesso!", "success");
      } else {
        const error = await response.json();
        showError("Erro ao exportar PDF: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao exportar PDF:", error);
      showError("Erro ao exportar PDF de auditoria");
    }
  }

  async function exportarLeiturasPDF() {
    const lote = document.getElementById("filtroLoteRelatorio").value;
    const dataInicio = document.getElementById("dataInicioLeituras").value;
    const dataFim = document.getElementById("dataFimLeituras").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "/api/relatorio/leituras/pdf?";

      const params = [];
      if (lote) params.push(`lote=${encodeURIComponent(lote)}`);
      if (dataInicio) params.push(`data_inicio=${dataInicio}`);
      if (dataFim) params.push(`data_fim=${dataFim}`);

      url += params.join("&");

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = downloadUrl;
        link.download = "leituras_embryotech.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);

        showMessage("PDF exportado com sucesso!", "success");
      } else {
        const error = await response.json();
        showError("Erro ao exportar PDF: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao exportar PDF:", error);
      showError("Erro ao exportar PDF de leituras");
    }
  }

  async function exportarUsuariosPDF() {
    const tipoUsuario = document.getElementById("filtroTipoUsuario").value;

    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "/api/relatorio/usuarios/pdf?";

      if (tipoUsuario) url += `tipo=${tipoUsuario}`;

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = downloadUrl;
        link.download = "usuarios_embryotech.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);

        showMessage("PDF exportado com sucesso!", "success");
      } else {
        const error = await response.json();
        showError("Erro ao exportar PDF: " + error.message);
      }
    } catch (error) {
      console.error("Erro ao exportar PDF:", error);
      showError("Erro ao exportar PDF de usu치rios");
    }
  }

  // === OUTRAS FUN칂칏ES NECESS츼RIAS ===

  async function fetchReadings(lote = "") {
    try {
      const token = localStorage.getItem("embryotech_token");
      let url = "{{ url_for('api_listar_leituras') }}";

      if (lote) {
        url += `?lote=${encodeURIComponent(lote)}`;
      }

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

      let readings = await response.json();

      readings = readings.map((r) => ({
        ...r,
        data_inicial: r.data_inicial ? new Date(r.data_inicial) : null,
        data_final: r.data_final ? new Date(r.data_final) : null,
      }));

      readings.sort((a, b) => {
        const dateA = a.data_inicial ? new Date(a.data_inicial) : new Date(0);
        const dateB = b.data_inicial ? new Date(b.data_inicial) : new Date(0);
        return dateB - dateA;
      });

      if (readings.length > 0) {
        updateLastReading(readings[0]);
        if (lote) {
          updateCharts([...readings].reverse());
        }
      } else {
        updateLastReading(null);
        if (lote) {
          updateCharts([]);
        }
      }
    } catch (error) {
      console.error("Erro ao buscar leituras:", error);
      showError(`Erro ao carregar leituras: ${error.message}`);
    }
  }

  async function initLoteFilter() {
    try {
      const token = localStorage.getItem("embryotech_token");
      const response = await fetch("{{ url_for('api_get_lotes') }}", {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) throw new Error("Erro ao carregar lotes");

      const lotes = await response.json();
      const loteFilter = document.getElementById("loteFilter");

      loteFilter.innerHTML = '<option value="">Todos os Lotes</option>';
      lotes.forEach((lote) => {
        const option = document.createElement("option");
        option.value = lote;
        option.textContent = lote;
        loteFilter.appendChild(option);
      });

      loteFilter.addEventListener("change", async () => {
        const loteSelecionado = loteFilter.value;
        const loteLabel = document.getElementById("loteLabel");

        if (loteSelecionado) {
          loteLabel.textContent = `Lote: ${loteSelecionado}`;
          await fetchReadings(loteSelecionado);
        } else {
          loteLabel.textContent =
            "Lote: Selecione um lote para visualizar os dados";
          updateCharts([]);
          updateLastReading(null);
        }
      });
    } catch (error) {
      console.error("Erro ao carregar lotes:", error);
      showError("Erro ao carregar lista de lotes");
    }
  }

  function updateLastReading(reading) {
    const lastReadingContainer = document.getElementById(
      "lastReadingContainer"
    );
    if (!lastReadingContainer) return;

    if (!reading) {
      lastReadingContainer.innerHTML = `
            <div class="reading-data">
                <p>Selecione um lote espec칤fico para visualizar a 칰ltima leitura</p>
            </div>
        `;
      return;
    }

    lastReadingContainer.innerHTML = `
        <div class="reading-data">
            <p><strong>Data/Hora:</strong> ${formatDate(
              reading.data_inicial
            )}</p>
            <p><strong>Temperatura:</strong> ${reading.temperatura} 춿C</p>
            <p><strong>Umidade:</strong> ${reading.umidade} %</p>
            <p><strong>Press칚o:</strong> ${reading.pressao} hPa</p>
            <p><strong>Lote:</strong> ${reading.lote || "N/A"}</p>
        </div>
    `;
  }

  function updateCharts(readings) {
    if (!readings || readings.length === 0) {
      tempChart.data.labels = [];
      tempChart.data.datasets[0].data = [];
      tempChart.update();

      umidChart.data.labels = [];
      umidChart.data.datasets[0].data = [];
      umidChart.update();

      pressChart.data.labels = [];
      pressChart.data.datasets[0].data = [];
      pressChart.update();

      return;
    }

    readings.sort(
      (a, b) => new Date(a.data_inicial) - new Date(b.data_inicial)
    );
    const labels = readings.map((r) => formatDate(r.data_inicial, true));
    const temps = readings.map((r) => r.temperatura);
    const umids = readings.map((r) => r.umidade);
    const presses = readings.map((r) => r.pressao);

    updateChart(tempChart, labels, temps);
    updateChart(umidChart, labels, umids);
    updateChart(pressChart, labels, presses);
  }

  function updateChart(chart, labels, data) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }

  function showHistoryModal() {
    const modal = document.getElementById("customModal");
    const loteSelecionado = document.getElementById("loteFilter").value;

    modal.style.display = "flex";

    setTimeout(() => {
      fetchHistoryReadings(loteSelecionado);
    }, 50);

    setupModalCloseEvents(modal);
  }

  async function fetchHistoryReadings(lote = "") {
    try {
      const token = localStorage.getItem("embryotech_token");
      const container = document.getElementById("readingsListContainer");

      if (!container) return;

      container.innerHTML = "<p>Carregando hist칩rico...</p>";

      let url = "{{ url_for('api_listar_leituras') }}";
      if (lote) {
        url += `?lote=${encodeURIComponent(lote)}`;
      }

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) throw new Error("Erro ao carregar hist칩rico");

      let readings = await response.json();
      readings = readings.map((r) => ({
        ...r,
        data_inicial: r.data_inicial ? new Date(r.data_inicial) : null,
        data_final: r.data_final ? new Date(r.data_final) : null,
      }));

      readings.sort(
        (a, b) => new Date(b.data_inicial) - new Date(a.data_inicial)
      );

      updateReadingsList(readings);
      updateReadingsCount(readings.length);
    } catch (error) {
      console.error("Erro em fetchHistoryReadings:", error);
      const container = document.getElementById("readingsListContainer");
      if (container) {
        container.innerHTML = `<p class="error">Erro ao carregar hist칩rico: ${error.message}</p>`;
      }
      showError("Erro ao carregar hist칩rico de leituras");
    }
  }

  function updateReadingsList(readings) {
    const container = document.getElementById("readingsListContainer");
    if (!container) return;

    if (!readings || readings.length === 0) {
      container.innerHTML = `
            <div class="empty-state">
                <p>Nenhuma leitura encontrada</p>
            </div>
        `;
      return;
    }

    container.innerHTML = `
        <div class="readings-grid">
            ${readings
              .map(
                (reading) => `
                <div class="reading-item">
                    <p><strong>Data:</strong> ${formatDate(
                      reading.data_inicial
                    )}</p>
                    <p><strong>Temperatura:</strong> ${
                      reading.temperatura
                    } 춿C</p>
                    <p><strong>Umidade:</strong> ${reading.umidade} %</p>
                    <p><strong>Press칚o:</strong> ${reading.pressao} hPa</p>
                    ${
                      reading.lote
                        ? `<p><strong>Lote:</strong> ${reading.lote}</p>`
                        : ""
                    }
                </div>
            `
              )
              .join("")}
        </div>
    `;
  }

  function updateReadingsCount(count) {
    const countElement = document.getElementById("readingsCount");
    if (countElement) {
      countElement.innerHTML = `<strong>Total de leituras:</strong> ${count}`;
    }
  }

  function formatDate(dateString, short = false) {
    if (!dateString) return "N/A";

    const date = new Date(dateString);
    const options = {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    };

    if (short) {
      return `${date.toLocaleDateString("pt-BR")} ${date.toLocaleTimeString(
        "pt-BR",
        {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        }
      )}`;
    }

    return date.toLocaleString("pt-BR", options);
  }
</script>

<style>
  #formCadastroUsuario {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-top: 2px solid #25691b;
  }

  #formCadastroUsuario h4 {
    color: #25691b;
    margin-bottom: 20px;
    font-size: 1.2rem;
    font-weight: 600;
  }

  #formCadastroUsuario .form-control {
    background-color: white;
    border: 2px solid #ddd;
    transition: border-color 0.3s;
  }

  #formCadastroUsuario .form-control:focus {
    border-color: #25691b;
    outline: none;
    box-shadow: 0 0 5px rgba(37, 105, 27, 0.3);
  }

  #formCadastroUsuario .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #25691b;
    font-size: 1rem;
  }

  #formCadastroUsuario .form-group label input[type="checkbox"] {
    display: inline;
    margin-bottom: 0;
    margin-right: 8px;
    transform: scale(1.2);
  }

  @media (max-width: 768px) {
    #formCadastroUsuario {
      padding: 15px;
      margin-top: 15px;
    }
  }
</style>

{% endblock %}
